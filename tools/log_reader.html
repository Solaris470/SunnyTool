<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô Log File</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="../assets/shared.css" rel="stylesheet">
    <style>
        body {
            background-color: #fafafa;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .controls-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .search-container {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
         .search-input {
             width: 100%;
             padding: 12px 0px;
             border: 2px solid #e1e8ed;
             border-radius: 8px;
             font-size: 14px;
             font-family: 'Courier New', monospace;
             transition: all 0.3s ease;
         }
        
        .search-input:focus {
            border-color: #2196f3;
            outline: none;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            background: white;
            min-width: 60px;
            text-align: center;
        }
        
        .filter-btn.active {
            color: white !important;
        }
        
        .filter-btn.error {
            border-color: #f44336;
            color: #f44336;
        }
        
        .filter-btn.error.active {
            background: #f44336;
        }
        
        .filter-btn.warn {
            border-color: #ff9800;
            color: #ff9800;
        }
        
        .filter-btn.warn.active {
            background: #ff9800;
        }
        
        .filter-btn.info {
            border-color: #2196f3;
            color: #2196f3;
        }
        
        .filter-btn.info.active {
            background: #2196f3;
        }
        
        .filter-btn.debug {
            border-color: #9e9e9e;
            color: #9e9e9e;
        }
        
        .filter-btn.debug.active {
            background: #9e9e9e;
        }
        
        .filter-btn.success {
            border-color: #4caf50;
            color: #4caf50;
        }
        
         .filter-btn.success.active {
             background: #4caf50;
         }
         
         .filter-btn.insert {
             border-color: #2196f3;
             color: #2196f3;
         }
         
         .filter-btn.insert.active {
             background: #2196f3;
         }
         
         .filter-btn.update {
             border-color: #ff9800;
             color: #ff9800;
         }
         
         .filter-btn.update.active {
             background: #ff9800;
         }
         
         .filter-btn.delete {
             border-color: #f44336;
             color: #f44336;
         }
         
         .filter-btn.delete.active {
             background: #f44336;
         }
         
         .filter-btn.select {
             border-color: #4caf50;
             color: #4caf50;
         }
         
         .filter-btn.select.active {
             background: #4caf50;
         }
         
         .filter-btn.other {
             border-color: #9e9e9e;
             color: #9e9e9e;
         }
         
         .filter-btn.other.active {
             background: #9e9e9e;
         }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background: #2196f3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        button:hover {
            background: #1976d2;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }
        
        .clear-btn {
            background: #f44336;
        }
        
        .clear-btn:hover {
            background: #d32f2f;
        }
        
        .format-btn {
            background: #4caf50;
        }
        
        .format-btn:hover {
            background: #388e3c;
        }
        
        .input-section {
            margin-bottom: 20px;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            border-color: #2196f3;
            outline: none;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }
        
        .log-viewer {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 0;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }
        
        .log-header {
            background: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-content {
            padding: 0;
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .log-line {
            padding: 4px 15px;
            border-bottom: 1px solid #333;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .log-line:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .log-line.highlighted {
            background: rgba(255, 235, 59, 0.2);
            border-left: 4px solid #ffeb3b;
        }
        
        .log-line.hidden {
            display: none;
        }
        
        .line-number {
            display: inline-block;
            width: 50px;
            color: #666;
            font-size: 11px;
            margin-right: 15px;
            text-align: right;
            user-select: none;
        }
        
         .log-timestamp {
             color: #79dac8;
             font-weight: bold;
         }
         
         .log-ip {
             color: #ff9800;
             font-weight: bold;
         }
         
         .log-user {
             color: #9c27b0;
             font-weight: bold;
         }
         
         .sql-command {
             color: #4caf50;
             font-weight: bold;
             text-transform: uppercase;
         }
         
         .sql-table {
             color: #2196f3;
             font-weight: bold;
         }
         
         .sql-values {
             color: #ff5722;
         }
        
        .log-level {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
            margin: 0 8px;
            text-transform: uppercase;
            min-width: 50px;
            text-align: center;
        }
        
        .log-level.error {
            background: #f44336;
            color: white;
        }
        
        .log-level.warn {
            background: #ff9800;
            color: white;
        }
        
        .log-level.info {
            background: #2196f3;
            color: white;
        }
        
        .log-level.debug {
            background: #9e9e9e;
            color: white;
        }
        
        .log-level.success {
            background: #4caf50;
            color: white;
        }
        
        .log-message {
            color: #f8f8f2;
        }
        
        .log-message.error {
            color: #ff6b6b;
        }
        
        .log-message.warn {
            color: #ffd93d;
        }
        
        .log-message.info {
            color: #74c0fc;
        }
        
        .log-message.success {
            color: #69db7c;
        }
        
        .stats-bar {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stats-item {
            text-align: center;
            font-size: 14px;
        }
        
        .stats-number {
            font-size: 18px;
            font-weight: bold;
            color: #2196f3;
            display: block;
        }
        
        .stats-label {
            color: #666;
            font-size: 12px;
        }
        
        .instruction {
            background-color: #e8f4fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .no-logs {
            text-align: center;
            padding: 50px 20px;
            color: #666;
            font-style: italic;
        }
        
        /* Fullscreen styles */
        body.fullscreen-mode {
            overflow: hidden;
        }

        body.fullscreen-mode .header,
        body.fullscreen-mode .sidebar,
        body.fullscreen-mode .sidebar-overlay,
        body.fullscreen-mode .main-content > .container > *:not(#log-area-container) {
            display: none;
        }
        
        body.fullscreen-mode .main-content {
            padding: 0;
            margin-left: 0;
        }

        #log-area-container {
            display: contents;
        }

        body.fullscreen-mode #log-area-container {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #fafafa;
            padding: 20px;
            box-sizing: border-box;
            gap: 20px;
            z-index: 1000;
        }

        body.fullscreen-mode #logViewer {
            flex: 3;
            margin: 0;
            height: 100%;
            max-height: none;
            order: 1; /* Log viewer on the left */
        }
        
        body.fullscreen-mode #right-column {
            flex: 1;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            order: 2; /* Controls on the right */
        }

        body.fullscreen-mode #right-column .controls-section,
        body.fullscreen-mode #right-column #statsBar {
            margin: 0;
        }

        body.fullscreen-mode #right-column #statsBar {
            display: flex;
        }

        .log-header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #fullscreenBtn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
        }
        
        #fullscreenBtn:hover {
            background: rgba(255,255,255,0.1);
            box-shadow: none;
            transform: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                min-width: auto;
            }
            
            .filter-buttons, .action-buttons {
                justify-content: center;
            }
            
            .stats-bar {
                flex-direction: column;
                text-align: center;
            }
        }
        
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <header class="header">
        <div class="logo">
            <span class="material-icons">wb_sunny</span>
            SunnyTool
        </div>
        <div class="header-nav">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <span class="material-icons">menu</span>
            </button>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-toggle" id="sidebarToggle">
                <span class="material-icons">menu_open</span>
            </button>
        </div>
        <ul class="sidebar-nav">
            <li><a href="../index.html"><span class="material-icons">home</span> <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a></li>
            <li><a href="thai_text_fixer.html"><span class="material-icons">translate</span> <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ó‡∏¢</span></a></li>
            <li><a href="clean_googlesheet_data.html"><span class="material-icons">table_chart</span> <span>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥</span></a></li>
            <li><a href="log_reader.html" class="active"><span class="material-icons">description</span> <span>‡∏≠‡πà‡∏≤‡∏ô Log File</span></a></li>
        </ul>
    </nav>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <div class="container">
            <h1>üìã ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô Log File</h1>
            
            <div class="instruction">
                <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</strong> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å log ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ search ‡∏´‡∏≤‡∏Ñ‡∏≥, ‡∏Å‡∏£‡∏≠‡∏á log ‡∏ï‡∏≤‡∏° level, ‡πÅ‡∏•‡∏∞ format ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <input type="file" id="fileInput" accept=".log,.txt" style="display: none;">
                    <button onclick="document.getElementById('fileInput').click()" style="background: #607d8b;">
                        <span class="material-icons" style="vertical-align: middle; font-size: 18px; margin-right: 5px;">upload_file</span>
                        ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Log
                    </button>
                    <span id="fileName" style="color: #666; font-size: 13px;"></span>
                </div>

                <label for="logInput" style="display: block; margin-bottom: 8px; font-weight: bold; color: #34495e;">
                    üìù ‡∏ß‡∏≤‡∏á log ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà:
                </label>
                <textarea id="logInput" placeholder="‡∏ß‡∏≤‡∏á database log ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...&#10;&#10;‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:&#10;09:06:13 134.236.242.170] admin (1) :insert into LOG_DETAIL (LOG_IP_ADDRESS) values ('192.168.1.1')&#10;09:12:09 134.236.242.170] admin (1) :update WF_STEP_FORM set WFS_NAME = 'test' where WFS_ID = '1054'&#10;09:12:10 134.236.242.170] admin (1) :delete from WF_STEP_JS where WFSJ_ID = '123'"></textarea>
            </div>
            
            <div id="log-area-container">
                <div id="right-column">
                    <!-- Search and Filter Controls -->
                    <div class="controls-section">
                        <div class="controls-row">
                            <div class="search-container">
                                <input type="text" id="searchInput" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° log... (‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)">
                                <span class="material-icons search-icon">search</span>
                            </div>
                            <div class="action-buttons">
                                <button onclick="clearFilters()" class="format-btn" title="‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">refresh</span>
                                    ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                                <button onclick="clearAll()" class="clear-btn" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">delete_sweep</span>
                                    Reset
                                </button>
                            </div>
                        </div>
                        
                        <div class="controls-row">
                             <div class="filter-buttons">
                                 <div class="filter-btn info insert" onclick="toggleFilter('insert')" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô INSERT commands">INSERT</div>
                                 <div class="filter-btn warn update" onclick="toggleFilter('update')" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô UPDATE commands">UPDATE</div>
                                 <div class="filter-btn error delete" onclick="toggleFilter('delete')" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô DELETE commands">DELETE</div>
                                 <div class="filter-btn success select" onclick="toggleFilter('select')" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô SELECT commands">SELECT</div>
                                 <div class="filter-btn debug other" onclick="toggleFilter('other')" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô Other commands">OTHER</div>
                             </div>
                        </div>
                    </div>

                    <!-- Stats Bar -->
                    <div id="statsBar" class="stats-bar" style="display: none;">
                        <div class="stats-item">
                            <span id="totalLines" class="stats-number">0</span>
                            <span class="stats-label">Total Lines</span>
                        </div>
                        <div class="stats-item">
                            <span id="visibleLines" class="stats-number">0</span>
                            <span class="stats-label">Visible</span>
                        </div>
                         <div class="stats-item">
                             <span id="insertCount" class="stats-number">0</span>
                             <span class="stats-label">INSERT</span>
                         </div>
                         <div class="stats-item">
                             <span id="updateCount" class="stats-number">0</span>
                             <span class="stats-label">UPDATE</span>
                         </div>
                         <div class="stats-item">
                             <span id="deleteCount" class="stats-number">0</span>
                             <span class="stats-label">DELETE</span>
                         </div>
                         <div class="stats-item">
                             <span id="selectCount" class="stats-number">0</span>
                             <span class="stats-label">SELECT</span>
                         </div>
                         <div class="stats-item">
                             <span id="otherCount" class="stats-number">0</span>
                             <span class="stats-label">OTHER</span>
                         </div>
                    </div>
                </div>

                <!-- Log Viewer -->
                <div id="logViewer" class="log-viewer" style="display: none;">
                    <div class="log-header">
                        <span>üìã Log Viewer</span>
                        <div class="log-header-controls">
                            <span id="logInfo">Ready</span>
                            <button id="fullscreenBtn" title="Toggle Fullscreen">
                                <span class="material-icons">fullscreen</span>
                            </button>
                        </div>
                    </div>
                    <div id="logContent" class="log-content">
                        <div class="no-logs">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ log ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á</div>
                    </div>
                </div>
            </div>
        </div>

        <script src="../assets/shared.js"></script>
        <script>
            let logData = [];
            let filteredData = [];
            let activeFilters = new Set();
            let searchTerm = '';

            // Auto-process logs when input changes
            document.getElementById('logInput').addEventListener('input', function() {
                const input = this.value;
                if (input.trim()) {
                    processLogs(input);
                } else {
                    clearLogs();
                }
            });

            // Handle File Upload
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                document.getElementById('fileName').textContent = `üìÑ ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î Memory ‡∏Ç‡∏≠‡∏á Textarea
                    document.getElementById('logInput').value = `[File Loaded] ${file.name}\nSize: ${(file.size/1024).toFixed(2)} KB\nLines: Estimating...`;
                    processLogs(content);
                };
                reader.readAsText(file);
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                searchTerm = this.value.toLowerCase();
                applyFilters();
            });

            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchTerm = this.value.toLowerCase();
                    applyFilters();
                }
            });

            function processLogs(input) {
                // Fix: Split by regex to handle \r\n (Windows) and \n (Linux/Mac) correctly
                // This fixes the issue where uploaded files weren't parsed correctly due to trailing \r
                const lines = input.split(/\r?\n/).filter(line => line.trim());
                logData = [];
                
                lines.forEach((line, index) => {
                    const logEntry = parseLogLine(line, index + 1);
                    logData.push(logEntry);
                });

                filteredData = [...logData];
                displayLogs();
                updateStats();
                document.getElementById('logViewer').style.display = 'block';
                document.getElementById('statsBar').style.display = 'flex';
            }

             function parseLogLine(line, lineNumber) {
                 const logEntry = {
                     lineNumber: lineNumber,
                     original: line,
                     timestamp: null,
                     ipAddress: null,
                     user: null,
                     sqlCommand: null,
                     level: 'other',
                     message: line,
                     formatted: line
                 };

                 // Parse database log format: [HH:mm:ss IP_ADDRESS] user (id) :SQL_COMMAND
                 const dbLogPattern = /^(?:\[)?(\d{2}:\d{2}:\d{2})\s+([0-9.]+)\]\s+([^:]+)\s*:\s*(.+)$/;
                 const match = line.match(dbLogPattern);
                 
                 if (match) {
                     logEntry.timestamp = match[1];
                     logEntry.ipAddress = match[2];
                     logEntry.user = match[3].trim();
                     logEntry.message = match[4].trim();
                     
                     // Determine SQL command type
                     const sqlCommand = match[4].trim().toLowerCase();
                     if (sqlCommand.startsWith('insert')) {
                         logEntry.level = 'insert';
                         logEntry.sqlCommand = 'INSERT';
                     } else if (sqlCommand.startsWith('update')) {
                         logEntry.level = 'update';
                         logEntry.sqlCommand = 'UPDATE';
                     } else if (sqlCommand.startsWith('delete')) {
                         logEntry.level = 'delete';
                         logEntry.sqlCommand = 'DELETE';
                     } else if (sqlCommand.startsWith('select')) {
                         logEntry.level = 'select';
                         logEntry.sqlCommand = 'SELECT';
                     } else {
                         logEntry.level = 'other';
                         logEntry.sqlCommand = 'OTHER';
                     }
                 }

                 // Format the log line
                 logEntry.formatted = formatLogLine(logEntry);

                 return logEntry;
             }

            function formatLogLine(logEntry) {
                let formatted = logEntry.original;
                
                // If parsed successfully, format with highlights
                if (logEntry.timestamp && logEntry.ipAddress && logEntry.user) {
                    // Create formatted version with highlights
                    const escapedTimestamp = escapeRegex(logEntry.timestamp);
                    const escapedIP = escapeRegex(logEntry.ipAddress);
                    const escapedUser = escapeRegex(logEntry.user);
                    
                    // Highlight timestamp
                    formatted = formatted.replace(
                        new RegExp(escapedTimestamp, 'g'),
                        `<span class="log-timestamp">${logEntry.timestamp}</span>`
                    );
                    
                    // Highlight IP address
                    formatted = formatted.replace(
                        new RegExp(`\\b${escapedIP}\\b`, 'g'),
                        `<span class="log-ip">${logEntry.ipAddress}</span>`
                    );
                    
                    // Highlight user
                    formatted = formatted.replace(
                        new RegExp(escapedUser, 'g'),
                        `<span class="log-user">${logEntry.user}</span>`
                    );
                    
                    // Highlight SQL commands
                    const sqlCommands = ['insert', 'delete', 'select', 'create', 'drop', 'alter'];
                    for (const cmd of sqlCommands) {
                        const pattern = new RegExp(`\\b(${cmd})\\b`, 'gi');
                        formatted = formatted.replace(pattern, '<span class="sql-command">$1</span>');
                    }
                    
                    // Highlight table names (words after FROM, INTO, UPDATE, JOIN)
                    formatted = formatted.replace(
                        /\b(update)\s+([A-Za-z_][A-Za-z0-9_]*)/gi,
                        '<span class="sql-command">$1</span> <span class="sql-table">$2</span>'
                    );
                    formatted = formatted.replace(
                        /\b(from|into|join)\s+([A-Za-z_][A-Za-z0-9_]*)/gi,
                        '$1 <span class="sql-table">$2</span>'
                    );
                    
                    // Highlight VALUES clause
                    formatted = formatted.replace(
                        /\b(values)\s*(\([^)]*\))/gi,
                        '<span class="sql-command">$1</span> <span class="sql-values">$2</span>'
                    );
                }

                return formatted;
            }

            function displayLogs() {
                const logContent = document.getElementById('logContent');
                
                if (filteredData.length === 0) {
                    logContent.innerHTML = '<div class="no-logs">‡πÑ‡∏°‡πà‡∏û‡∏ö log ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>';
                    return;
                }

                // LIMIT DISPLAY to prevent browser crash with 500k lines
                const MAX_DISPLAY = 2000;
                const displayData = filteredData.slice(0, MAX_DISPLAY);
                
                let html = '';
                displayData.forEach(logEntry => {
                    const isHighlighted = searchTerm && logEntry.original.toLowerCase().includes(searchTerm);
                    html += `
                        <div class="log-line ${isHighlighted ? 'highlighted' : ''}" data-level="${logEntry.level}">
                            <span class="line-number">${logEntry.lineNumber}</span>
                            <span class="log-message ${logEntry.level}">${logEntry.formatted}</span>
                        </div>
                    `;
                });

                if (filteredData.length > MAX_DISPLAY) {
                    html += `
                        <div class="log-line" style="background: #fff3cd; color: #856404; text-align: center; padding: 10px;">
                            ‚ö†Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${MAX_DISPLAY.toLocaleString()} ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${filteredData.length.toLocaleString()}) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Browser ‡∏Ñ‡πâ‡∏≤‡∏á <br>
                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ <b>Search</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>Filter</b> ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                        </div>
                    `;
                }

                logContent.innerHTML = html;
                document.getElementById('logInfo').textContent = `${filteredData.length.toLocaleString()} lines (Matches)`;
            }

            function updateStats() {
                const stats = {
                    total: logData.length,
                    visible: filteredData.length,
                    insert: logData.filter(log => log.level === 'insert').length,
                    update: logData.filter(log => log.level === 'update').length,
                    delete: logData.filter(log => log.level === 'delete').length,
                    select: logData.filter(log => log.level === 'select').length,
                    other: logData.filter(log => log.level === 'other').length
                };

                document.getElementById('totalLines').textContent = stats.total;
                document.getElementById('visibleLines').textContent = stats.visible;
                document.getElementById('insertCount').textContent = stats.insert;
                document.getElementById('updateCount').textContent = stats.update;
                document.getElementById('deleteCount').textContent = stats.delete;
                document.getElementById('selectCount').textContent = stats.select;
                document.getElementById('otherCount').textContent = stats.other;
            }

            function toggleFilter(level) {
                const filterBtn = document.querySelector(`.filter-btn.${level}`);
                
                if (activeFilters.has(level)) {
                    activeFilters.delete(level);
                    filterBtn.classList.remove('active');
                } else {
                    activeFilters.add(level);
                    filterBtn.classList.add('active');
                }
                
                applyFilters();
            }

            function applyFilters() {
                filteredData = logData.filter(logEntry => {
                    // Apply level filters (if any are active)
                    if (activeFilters.size > 0 && !activeFilters.has(logEntry.level)) {
                        return false;
                    }
                    
                    // Apply search filter
                    if (searchTerm && !logEntry.original.toLowerCase().includes(searchTerm)) {
                        return false;
                    }
                    
                    return true;
                });

                displayLogs();
                updateStats();
            }

            function formatLogs() {
                const input = document.getElementById('logInput').value.trim();
                if (!input) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• log ‡∏Å‡πà‡∏≠‡∏ô');
                    return;
                }

                // Simple formatting - add line breaks and indentation
                const lines = input.split('\n');
                const formatted = lines
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .join('\n');

                document.getElementById('logInput').value = formatted;
                processLogs(formatted);
            }

            function clearAll() {
                 if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                     document.getElementById('logInput').value = '';
                     document.getElementById('searchInput').value = '';
                     document.getElementById('fileName').textContent = ''; // Clear filename
                     document.getElementById('fileInput').value = ''; // Reset file input
                     clearLogs();
                     clearFilters();
                 }
            }

            function clearLogs() {
                logData = [];
                filteredData = [];
                searchTerm = '';
                document.getElementById('logViewer').style.display = 'none';
                document.getElementById('statsBar').style.display = 'none';
            }

            function clearFilters() {
                document.getElementById('searchInput').value = '';
                // formatLogs(); // Remove this dangerous call
                activeFilters.clear();
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                applyFilters(); // Use applyFilters instead to refresh view from memory
            }

            function escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // Fullscreen functionality
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const body = document.body;
            
            fullscreenBtn.addEventListener('click', () => {
                body.classList.toggle('fullscreen-mode');
                const icon = fullscreenBtn.querySelector('.material-icons');
                if (body.classList.contains('fullscreen-mode')) {
                    icon.textContent = 'fullscreen_exit';
                } else {
                    icon.textContent = 'fullscreen';
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && body.classList.contains('fullscreen-mode')) {
                    body.classList.remove('fullscreen-mode');
                    fullscreenBtn.querySelector('.material-icons').textContent = 'fullscreen';
                }
            });

            // Load sample data for demonstration
            /*
            window.addEventListener('load', function() {
                const sampleData = `09:06:13 134.236.242.170] admin (1) :insert into LOG_DETAIL (LOG_IP_ADDRESS, LOG_USR_ID, LOG_CREATE_DATE, LOG_DETAIL, LOG_CREATE_TIME, LOG_ID) values ('134.236.242.170', '1', '2025-09-16', 'login ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', '09:06:13', '4920')
09:12:09 134.236.242.170] admin (1) :update WF_STEP_FORM set FORM_MAIN_ID = '2', WFS_RELATION_TYPE = NULL, WFS_TOOLTIP = NULL, WFS_NAME = '‡∏ö‡∏ó‡∏Ñ‡∏±‡∏î‡∏¢‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', WFS_COMMENT = NULL where WFS_ID = '1054'
09:12:09 134.236.242.170] admin (1) :delete from WF_STEP_JS where 1=1 and WFSJ_ID = NULL
09:12:10 192.168.1.100] user2 (5) :select * from USER_PROFILES where USER_ID = '5' and STATUS = 'ACTIVE'
09:13:15 10.0.0.50] developer (10) :insert into ERROR_LOG (ERROR_MSG, ERROR_TIME, USER_ID) values ('Connection timeout', '09:13:15', '10')
09:14:20 134.236.242.170] admin (1) :update WF_STEP_FORM set WFS_NUM_STEP_OPTION = '0', WFS_NUM_STEP_THROW = '0', WFS_NUM_STEP_JS = '0' where WFS_ID = '1054'
09:15:30 192.168.1.200] manager (3) :delete from TEMP_DATA where CREATE_DATE < '2025-09-01'
09:16:45 10.0.0.75] api_user (15) :select COUNT(*) from ACTIVE_SESSIONS where LOGIN_TIME > '2025-09-16 08:00:00'
09:17:12 134.236.242.170] admin (1) :delete from WF_ONCHANGE where WFS_ID = '1054'
09:18:30 192.168.1.150] reporter (8) :insert into REPORT_QUEUE (REPORT_TYPE, USER_ID, REQUEST_TIME) values ('MONTHLY', '8', '09:18:30')`;
                
                document.getElementById('logInput').value = sampleData;
                processLogs(sampleData);
            });
            */
        </script>
    </main>
</body>
</html>
